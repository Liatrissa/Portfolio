<h3 align="center">Формирование RFM-сегментов </h3>

&nbsp;&nbsp;&nbsp;&nbsp;Для определения оптимальных пороговых значений для классификации
клиентов используем метод квантилей. Для этого нужно поочередно
упорядочить данные по каждой из метрик, а затем разделить пользователей
на равные группы. В данном исследовании будем выделять 3 класса примерно
по 33 % пользователей в каждом.

&nbsp;&nbsp;&nbsp;&nbsp;Выбор использование метода квантилей обусловлен: во-первых метод
квантилей основан на порядковых значениях, поэтому он учитывает иерархию
данных и сохраняет порядок значений в каждом классе. Во-вторых при
разбиении на три класса с использованием метода квантилей, вероятность
попадания клиентов в каждый класс будет примерно одинакова. Это
позволяет отслеживать различные типы клиентов и принимать
соответствующие меры по улучшению взаимодействия с ними.

&nbsp;&nbsp;&nbsp;&nbsp;После определения квантилей, мы применяем их для классификации клиентов
в разбивке метрик Recency (далее R), Frequency (далее F), Monetary
(далее M).

&nbsp;&nbsp;&nbsp;&nbsp;Определяем следующие классы:

-   Класс 1: метрики R до 33-го перцентиля, F, M выше 66-го перцентиля
    > (для R- с момента покупки прошло мало времени, для F- покупки
    > совершаются часто, для M- сумма покупок большая)

-   Класс 2: метрики R, F, M между 33-м и 66-м перцентилем
    > (для R- с момента покупки прошло относительно немного времени, для F-
    > покупки совершаются периодически, для M- сумма покупок средняя).

-   Класс 3: метрики R выше 66-го перцентиля, F, M до 33-го перцентиля
    > (для R- с момента покупки прошло много времени, для F- покупки
    > совершаются в основном разовые, для M- сумма покупок маленькая).

&nbsp;&nbsp;&nbsp;&nbsp;Получаем следующие классы для RFM-метрик:


| Класс |  Recency (Давность последней покупки)| Frequency (Частота покупок) |Monetary (Сумма всех покупок) |
|-------|--------------------------------------|-----------------------------|------------------------------|
| 1     | от 29 дней                           | от 6 покупок                |от 4130 рублей                |
| 2     | от 30 дней до 99 дней                | от 4 до 5 покупок           |от 1757 до 4129 рублей        |
| 3     | от 100 дней                          | до 3 покупок                |менее 1756 рублей             |


&nbsp;&nbsp;&nbsp;&nbsp;В SQL запросе (в CTE "transactions", "rfm") первоначально были
рассчитаны значения RFM-метрик для каждого пользователя, исключая
позиции в базе, в которых невозможно было идентифицировать пользователя.

&nbsp;&nbsp;&nbsp;&nbsp;Далее необходимо рассчитать оптимальные пороговые значения для
классификации клиентов, для этого можно воспользоваться функцией
percent_rank() для расчета процентного ранга(перцентиля) для каждого
значения RFM-метрик (расчет приведен в CTE "rfm_percentile").

&nbsp;&nbsp;&nbsp;&nbsp;Затем на основании полученных данных можно разбить RFM- показатели на
классы (это сделано в CTE "rfm_class"). Рассчитав оптимальные границы
для классификации клиентов можно сформировать RFM-сегменты на основе
комбинации значений Recency, Frequency и Monetary. Используем матрицу
3х3 для классификации клиентов по трём метрикам, где каждый параметр
делится на 3 вышеописанных класса. Таким образом, получим 27 различных
сегментов.

&nbsp;&nbsp;&nbsp;&nbsp;В основном блоке запроса объединили все RFM-показатели для определения
RFM-сегмента, к которому будет относится пользователь, также рассчитали
количество клиентов для каждого сегмента, это необходимо для
последующего анализа сегментов.

&nbsp;&nbsp;&nbsp;&nbsp;На основе полученных результатов RFM-анализа наблюдаем, что клиенты
аптечной сети, разделились на 27 группы, но при этом многие группы
достаточно небольшие, соответственно, есть смысл проанализировать все
получившиеся группы и целесообразнее акцентировать внимание на более
широкие группы клиентов, поэтому можно объединить некоторые
малочисленные группы со схожими группами по стратегии работы с ними.
