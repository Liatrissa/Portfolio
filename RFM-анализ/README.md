<h2 align="center">RFM-анализ клиентской базы аптечной сети </a>
<h3 align="center">Цель исследования: </h3>
&nbsp;&nbsp;&nbsp;&nbsp;Основной мотив исследования: близится спад сезона продаж и выручка в аптечной сети начнет падать. Необходимо найти способы адаптации к сезонному спаду продаж. Для привлечения покупателей к покупки компания собирается провести персонализированную рассылку в зависимости от платежного поведения клиентов. <br>
  <hr></hr>
Главные цели исследования:

1.  Провести классификацию пользователей

2.  Сформировать рекомендации - какой группе пользователей что предлагать.

&nbsp;&nbsp;&nbsp;&nbsp;В исследовании воспользуемся инструментом сегментации пользователей -
RFM-анализом клиентский базы аптечной сети. Данный анализ делит
пользователей на определенные группы в зависимости от давности, частоты
и общей суммы их платежей. Задача такого анализа-изучить поведение
пользователей и то, как они совершают платежи, чтобы сделать более
релевантные предложения каждой из выделенных групп.

&nbsp;&nbsp;&nbsp;&nbsp;Для исследования использовалась таблица с транзакциями по бонусной
системе "bonuscheques" базы данных Apteka, в частности были взяты
данные:

-   datetime - дата и время совершения транзакции

-   summ_with_disc - сумма чека с учетом скидок и списаний бонусов

-   card - номер бонусной карты

&nbsp;&nbsp;&nbsp;&nbsp;Если в момент покупки касса была в оффлайн-режиме, то вместо номера
карты записывается зашифрованная последовательность символов. В таком
случае номер карты силами этой базы данных никак восстановить нельзя. В
таком случае идентифицировать клиента не предоставляется возможным,
поэтому такие позиции в расчет не брались.
  <hr></hr>
<h3 align="center">Выбор метрик для анализа </h3>

&nbsp;&nbsp;&nbsp;&nbsp;Метрики для анализа следующие:

Recency (R) - количество дней с последней покупки каждого клиента. Чем
меньше число, тем более \"свежим\" является клиент (для определения
давности платежа)

Frequency (F) - количество покупок клиента за определенный период
времени (для определения частоты покупок)

Monetary (M) - сумма потраченных клиентом денег за определенный период
времени (для определения общей суммы покупок).

&nbsp;&nbsp;&nbsp;&nbsp;Все эти три метрики рассчитываются отдельно для каждого пользователя за
выбранный период, после чего пользователям проставляется оценка по
каждой из трех метрик. Рассматриваемый период в исследовании с
12.07.2021 по 09.06.2022 гг.

 <hr></hr>

 <h3 align="center">Расчет RFM показателей </h3>
Для расчета показателя Recency (давность покупки) используется подзапрос
"transactions", в котором выбирается последняя транзакция для каждой
карты и исключаются карты,которые не имеют привязок к клиентам. Затем
вычисляется количество дней от даты последней транзакции до 09.06.2022
г. (т.к. это крайняя дата в рассматриваемом периоде).

Для расчета показателя Frequency подсчитывается общее количество покупок
(по дате) для каждой карты.

Для расчета показателя Monetary используется запрос, в котором
суммируются все суммы покупок для каждой карты.

<hr></hr>

<h3 align="center">Формирование RFM-сегментов </h3>

Для определения оптимальных пороговых значений для классификации
клиентов используем метод квантилей. Для этого нужно поочередно
упорядочить данные по каждой из метрик, а затем разделить пользователей
на равные группы. В данном исследовании будем выделять 3 класса примерно
по 33 % пользователей в каждом.

Выбор использование метода квантилей обусловлен: во-первых метод
квантилей основан на порядковых значениях, поэтому он учитывает иерархию
данных и сохраняет порядок значений в каждом классе. Во-вторых при
разбиении на три класса с использованием метода квантилей, вероятность
попадания клиентов в каждый класс будет примерно одинакова. Это
позволяет отслеживать различные типы клиентов и принимать
соответствующие меры по улучшению взаимодействия с ними.

После определения квантилей, мы применяем их для классификации клиентов
в разбивке метрик Recency (далее R), Frequency (далее F), Monetary
(далее M).

Определяем следующие классы:

-   Класс 1: метрики R до 33-го перцентиля, F, M выше 66-го перцентиля
    > (для R- с момента покупки прошло мало времени, для F- покупки
    > совершаются часто, для M- сумма покупок большая)

-   Класс 2: метрики R, F, M между 33-м и 66-м перцентилем (для R- с
    > момента покупки прошло относительно немного времени, для F-
    > покупки совершаются периодически, для M- сумма покупок средняя).

-   Класс 3: метрики R выше 66-го перцентиля, F, M до 33-го перцентиля
    > (для R- с момента покупки прошло много времени, для F- покупки
    > совершаются в основном разовые, для M- сумма покупок маленькая).

Получаем следующие классы для RFM-метрик:


| Класс |  Recency (Давность последней покупки)| Frequency (Частота покупок) |Monetary (Сумма всех покупок) |
|-------|--------------------------------------|-----------------------------|------------------------------|
| 1     | от 29 дней                           | от 6 покупок                |от 4130 рублей                |
| 2     | от 30 дней до 99 дней                | от 4 до 5 покупок           |от 1757 до 4129 рублей        |
| 3     | от 100 дней                          | до 3 покупок                |менее 1756 рублей             |


В SQL запросе (в CTE "transactions", "rfm") первоначально были
рассчитаны значения RFM-метрик для каждого пользователя, исключая
позиции в базе, в которых невозможно было идентифицировать пользователя.

Далее необходимо рассчитать оптимальные пороговые значения для
классификации клиентов, для этого можно воспользоваться функцией
percent_rank() для расчета процентного ранга(перцентиля) для каждого
значения RFM-метрик (расчет приведен в CTE "rfm_percentile").

Затем на основании полученных данных можно разбить RFM- показатели на
классы (это сделано в CTE "rfm_class"). Рассчитав оптимальные границы
для классификации клиентов можно сформировать RFM-сегменты на основе
комбинации значений Recency, Frequency и Monetary. Используем матрицу
3х3 для классификации клиентов по трём метрикам, где каждый параметр
делится на 3 вышеописанных класса. Таким образом, получим 27 различных
сегментов.

В основном блоке запроса объединили все RFM-показатели для определения
RFM-сегмента, к которому будет относится пользователь, также рассчитали
количество клиентов для каждого сегмента, это необходимо для
последующего анализа сегментов.

[SQL запрос для определения RFM-сегментов](https://github.com/Liatrissa/Portfolio/blob/main/RFM-%D0%B0%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7/RFM_%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82%D1%8B.sql)

